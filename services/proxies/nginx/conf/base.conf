log_format lab '$remote_addr - $remote_user [$time_local] "$request" '
                'status=$status uri="$uri" req_uri="$request_uri" args="$args" loc="$loc" '
                'host="$host" ref="$http_referer" ua="$http_user_agent" xff="$http_x_forwarded_for"';

upstream backend_up {
    server backend-python:8000;
}

server {
    listen 80;
    access_log /var/log/nginx/access.log lab;
    # default location alias (overridden per location)
    set $loc "server";

    # Demo locations to show proxy_pass behavior
    # 1) Without trailing slash in proxy_pass: forwards /py1/... unchanged to upstream
    location /py1 {
        set $loc "py1";
        proxy_pass http://backend_up/public;  # no trailing slash: upstream path becomes /public/py1/...
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-NGX-Request-URI $request_uri;
        proxy_set_header X-NGX-URI $uri;
        proxy_set_header X-NGX-Args $args;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_request_buffering on;
        client_max_body_size 50m;
    }

    # 2) With trailing slash in proxy_pass: strips /py2/ prefix and forwards the remainder
    location /py2/ {
        set $loc "py2";
        proxy_pass http://backend_up/public/;  # trailing slash: drop /py2 prefix, upstream path /public/<rest>
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-NGX-Request-URI $request_uri;
        proxy_set_header X-NGX-URI $uri;
        proxy_set_header X-NGX-Args $args;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_request_buffering on;
        client_max_body_size 50m;
    }

    # Proxy defaults aiming to be transparent-ish
    location / {
        set $loc "root";
        proxy_pass http://backend_up/public/;  # default: forward everything to /public
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        # Expose Nginx view of URI variables to backend
        proxy_set_header X-NGX-Request-URI $request_uri;
        proxy_set_header X-NGX-URI $uri;
        proxy_set_header X-NGX-Args $args;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_request_buffering on;
        client_max_body_size 50m;
    }
}
